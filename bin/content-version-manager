#!/usr/bin/env node

var redis = require('../lib/redis-client');

var argv = require('minimist')(process.argv, {
  default: {
    context: undefined,
    version: "next",
    prefix: "content:",
    redis: "redis://localhost:6379"
  }
});

if (argv.h || argv.help || !argv.context) {
  console.log([
    'usage: version-manager [options]',
    '',
    '  --context context  Context (required!)',
    '  --version          Version [next]',
    '  --prefix prefix    Prefix for Redis keys [content:]',
    '  --redis            Redis server URL [redis://localhost:6379]'
  ].join("\n"));
  process.exit(1);
}

if (!argv.context) {
  console.log("No context specified");
  process.exit(1);
}

if (!argv.context.startsWith("/")) {
  argv.context = "/" + argv.context;
}

redis.init(argv.redis);

redis.client().set(argv.prefix + argv.context + ':current', argv.version, function(err) {
  var exitCode = 0;
  if (err) {
    exitCode = 2;
    console.error("ERROR: " + err);
  } else {
    console.log("OK New default version for context '" + argv.context + "': " + argv.version);
  }
  redis.client().quit();
  process.exit(exitCode);
});
